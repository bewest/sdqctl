# Directive Reference

Complete reference for sdqctl ConversationFile directives.

> **See also**: [README.md](../README.md) for quick reference table  
> **Extracted from**: proposals/BACKLOG.md Â§Directive Candidates Analysis (2026-01-25)

---

## Currently Implemented (74 directives)

### Metadata Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `MODEL` | Set AI model | `MODEL gpt-4` |
| `ADAPTER` | Set AI provider | `ADAPTER copilot` |
| `MODE` | Execution mode (audit, read-only, full) | `MODE audit` |
| `MAX-CYCLES` | Maximum iteration cycles | `MAX-CYCLES 5` |
| `CWD` | Working directory | `CWD ./backend` |
| `SESSION-NAME` | Named session for resumability | `SESSION-NAME my-feature` |

### Model Requirements (Abstract Model Selection)

| Directive | Purpose | Example |
|-----------|---------|---------|
| `MODEL-REQUIRES` | Capability requirement | `MODEL-REQUIRES context:50k` |
| `MODEL-PREFERS` | Soft preference | `MODEL-PREFERS vendor:anthropic` |
| `MODEL-POLICY` | Resolution policy | `MODEL-POLICY cheapest` |

### Context Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `CONTEXT` | Include files (required) | `CONTEXT @lib/*.py` |
| `CONTEXT-OPTIONAL` | Include files (optional) | `CONTEXT-OPTIONAL @docs/*.md` |
| `CONTEXT-EXCLUDE` | Exclude patterns from validation | `CONTEXT-EXCLUDE conformance/**` |
| `CONTEXT-LIMIT` | Context window threshold | `CONTEXT-LIMIT 80%` |
| `ON-CONTEXT-LIMIT` | Action when limit reached | `ON-CONTEXT-LIMIT compact` |
| `VALIDATION-MODE` | Validation strictness | `VALIDATION-MODE lenient` |
| `REFCAT` | Code excerpt injection | `REFCAT @file.py#L10-L50` or `REFCAT @src/**/*.py` |

### File Control Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `ALLOW-FILES` | Whitelist file patterns | `ALLOW-FILES ./lib/*` |
| `DENY-FILES` | Blacklist file patterns | `DENY-FILES ./secrets/*` |
| `ALLOW-DIR` | Whitelist directories | `ALLOW-DIR ./src` |
| `DENY-DIR` | Blacklist directories | `DENY-DIR ./node_modules` |

### Prompt Injection Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `PROLOGUE` | Prepend to first prompt | `PROLOGUE Current date: {{DATE}}` |
| `EPILOGUE` | Append to last prompt | `EPILOGUE Update progress.md` |
| `HEADER` | Prepend to output | `HEADER # Report` |
| `FOOTER` | Append to output | `FOOTER ---\nGenerated by sdqctl` |
| `HELP` | Inject help topic (prologue) | `HELP directives workflow` |
| `HELP-INLINE` | Inject help before next prompt | `HELP-INLINE stpa gap-ids` |

### Prompt Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `PROMPT` | Instruction to send to AI | `PROMPT Analyze the codebase` |
| `ON-CONTEXT-LIMIT-PROMPT` | Prompt when context limit hit | `ON-CONTEXT-LIMIT-PROMPT Summarize` |

### Compaction Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `COMPACT` | Trigger compaction | `COMPACT` |
| `COMPACT-PRESERVE` | What to preserve | `COMPACT-PRESERVE decisions` |
| `COMPACT-SUMMARY` | Summary prompt | `COMPACT-SUMMARY Focus on findings` |
| `COMPACT-PROLOGUE` | Before compacted summary | `COMPACT-PROLOGUE Context:` |
| `COMPACT-EPILOGUE` | After compacted summary | `COMPACT-EPILOGUE Continue work` |
| `NEW-CONVERSATION` | Start fresh context | `NEW-CONVERSATION` |
| `ELIDE` | Merge adjacent elements | `ELIDE` |

### Infinite Sessions (SDK Native Compaction)

| Directive | Purpose | Example |
|-----------|---------|---------|
| `INFINITE-SESSIONS` | Enable/disable SDK compaction | `INFINITE-SESSIONS enabled` |
| `COMPACTION-MIN` | Min density % to trigger | `COMPACTION-MIN 30%` |
| `COMPACTION-THRESHOLD` | Background compaction threshold | `COMPACTION-THRESHOLD 80%` |
| `COMPACTION-MAX` | Buffer exhaustion threshold | `COMPACTION-MAX 95%` |

### Checkpoint Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `CHECKPOINT` | Save state | `CHECKPOINT analysis-complete` |
| `CHECKPOINT-AFTER` | When to checkpoint | `CHECKPOINT-AFTER each-cycle` |
| `CHECKPOINT-NAME` | Named checkpoint | `CHECKPOINT-NAME phase-1` |
| `PAUSE` | Stop for human review | `PAUSE Review findings` |
| `CONSULT` | Pause with question presentation | `CONSULT Need clarification` |
| `CONSULT-TIMEOUT` | Expiration for CONSULT | `CONSULT-TIMEOUT 1h` |

### Output Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `OUTPUT` | Output content | `OUTPUT results` |
| `OUTPUT-FORMAT` | Output format | `OUTPUT-FORMAT markdown` |
| `OUTPUT-FILE` | Output destination | `OUTPUT-FILE report.md` |
| `OUTPUT-DIR` | Output directory | `OUTPUT-DIR reports/` |

### RUN Directives (Command Execution)

| Directive | Purpose | Example |
|-----------|---------|---------|
| `RUN` | Execute command | `RUN pytest tests/` |
| `RUN-ON-ERROR` | Error handling | `RUN-ON-ERROR continue` |
| `RUN-OUTPUT` | When to include output | `RUN-OUTPUT on-error` |
| `RUN-OUTPUT-LIMIT` | Max output chars | `RUN-OUTPUT-LIMIT 10K` |
| `RUN-ENV` | Set environment variable | `RUN-ENV DEBUG=1` |
| `RUN-CWD` | Working directory | `RUN-CWD ./backend` |
| `RUN-TIMEOUT` | Command timeout | `RUN-TIMEOUT 2m` |
| `ALLOW-SHELL` | Enable shell features | `ALLOW-SHELL true` |
| `RUN-ASYNC` | Run asynchronously | `RUN-ASYNC npm run dev` |
| `RUN-WAIT` | Wait for async command | `RUN-WAIT` |
| `RUN-RETRY` | Retry with AI fix | `RUN-RETRY 3 "Fix errors"` |

### Branching Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `ON-FAILURE` | Block on RUN failure | `ON-FAILURE` |
| `ON-SUCCESS` | Block on RUN success | `ON-SUCCESS` |
| `END` | End conditional block | `END` |

### Verification Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `VERIFY` | Run verification | `VERIFY refs` |
| `VERIFY-ON-ERROR` | Error handling | `VERIFY-ON-ERROR continue` |
| `VERIFY-OUTPUT` | When to include output | `VERIFY-OUTPUT on-error` |
| `VERIFY-LIMIT` | Max output chars | `VERIFY-LIMIT 50K` |
| `VERIFY-TRACE` | Verify traceability | `VERIFY-TRACE REQ-001` |
| `VERIFY-COVERAGE` | Verify coverage | `VERIFY-COVERAGE` |
| `CHECK-REFS` | Alias for VERIFY refs | `CHECK-REFS` |
| `CHECK-LINKS` | Alias for VERIFY links | `CHECK-LINKS` |
| `CHECK-TRACEABILITY` | Alias for VERIFY traceability | `CHECK-TRACEABILITY` |

### Pre-flight Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `REQUIRE` | Pre-flight check | `REQUIRE @file.py cmd:git` |

### Inclusion Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `INCLUDE` | Include workflow fragment | `INCLUDE @common/setup.conv` |

### Debug Directives

| Directive | Purpose | Example |
|-----------|---------|---------|
| `DEBUG` | Enable debug output | `DEBUG session tool` |
| `DEBUG-INTENTS` | Log agent intents | `DEBUG-INTENTS` |
| `EVENT-LOG` | Log SDK events to file | `EVENT-LOG events.jsonl` |

---

## Proposed but NOT Implemented

| Directive | Source Proposal | Priority | Notes |
|-----------|-----------------|----------|-------|
| `VERIFY-IMPLEMENTED` | STPA-INTEGRATION | P2 | Pattern search in code to verify safety constraints |

---

## Rejected Directives

| Directive | Source | Rejection Reason |
|-----------|--------|------------------|
| `SECTION` | RUN-BRANCHING | "This is a programming language now" - complexity concern |
| `GOTO` | RUN-BRANCHING | Rejected in favor of simpler ON-FAILURE blocks |

---

## Directive Candidates (Not Yet Proposed)

Potential additions based on usage patterns:

| Candidate | Description | Use Case |
|-----------|-------------|----------|
| `GATE` | Wait for condition | CI integration |
| `TIMEOUT` | Global workflow timeout | Long-running protection |
| `RETRY-LIMIT` | Global retry cap | Token budget control |

---

## See Also

- [README.md](../README.md) - Quick reference directive table
- [WORKFLOW-DESIGN.md](WORKFLOW-DESIGN.md) - Workflow design patterns
- [PHILOSOPHY.md](PHILOSOPHY.md) - Design principles
- [GETTING-STARTED.md](GETTING-STARTED.md) - Usage examples
