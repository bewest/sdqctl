# sdqctl Progress Report

## Session: 2026-01-21T08:59:08

**Branch:** main | **Commit:** f225aa3

---

## Cycle 1, Prompt 1

Done! Implemented **P0-1: Config File Loading**:

**Changes made:**
1. **Created `sdqctl/core/config.py`** - Config loader that searches cwd ‚Üí parent dirs (stops at git root) ‚Üí `~/.sdqctl.yaml`
2. **Updated `sdqctl/core/conversation.py`** - ConversationFile now uses `default_factory` functions to load config-based defaults for `model`, `adapter`, and `context_limit`
3. **Created `tests/test_config.py`** - 23 tests covering parsing, search paths, caching, and integration
4. **Fixed `tests/test_conversation.py`** - Updated test to clear config cache

**Test status:** 342/342 passing

**Committed:** `628fc46 feat(config): Implement .sdqctl.yaml config file loading`

---

## Cycle 1, Prompt 2

Done! Implemented **P0-2: Shell Injection Vulnerability Fix**:

**Changes made:**
1. **`sdqctl/core/conversation.py`** - Added `ALLOW_SHELL` directive type and `allow_shell: bool = False` field
2. **`sdqctl/commands/run.py`** - RUN now uses `shlex.split()` by default; only uses `shell=True` when `allow_shell` is explicitly enabled
3. **`tests/test_run_command.py`** - Added 9 tests for shell security

**Security improvement:**
- Default behavior is now safe (no shell injection possible)
- Workflows that need shell features (pipes, redirects, command substitution) must explicitly add `ALLOW-SHELL true`

**Test status:** 351/351 passing

**Committed:** `566a571 security(run): Fix shell injection vulnerability in RUN directive`

---

## Cycle 1, Prompt 3

Done! Implemented **P1-1: Resource Leak in Error Paths**:

**Changes made:**
1. **`sdqctl/commands/run.py`** - Restructured with nested try/finally:
   - Outer try/finally calls `adapter.stop()`
   - Inner try/finally calls `destroy_session(adapter_session)`
   - Removed manual cleanup from early return paths

2. **`sdqctl/commands/cycle.py`** - Applied same pattern

**Improvement:** Sessions are now properly cleaned up in all error paths, preventing resource leaks.

**Test status:** 351/351 passing

**Committed:** `6bee174 fix(lifecycle): Fix resource leak in adapter error paths`

---

## Cycle 2, Prompt 1

Done! Implemented **P1-2: Context Files Not Filtered by Restrictions**:

**Changes made:**
1. **`sdqctl/core/context.py`** - Added `path_filter` parameter to ContextManager; `add_file()` respects the filter
2. **`sdqctl/core/session.py`** - Session passes `FileRestrictions.is_path_allowed` as the filter when restrictions are configured
3. **`tests/test_context.py`** - Added 6 tests for path filtering

**Security improvement:** CONTEXT directives now respect ALLOW-FILES/DENY-FILES restrictions. A workflow with `DENY-FILES *secret*` will not load secret files even via `CONTEXT @*.py`.

**Test status:** 357/357 passing

**Committed:** `6b4b3dd fix(context): Apply file restrictions to context loading`

---

## Cycle 2, Prompt 2

Done! Implemented **P2-3: RUN-TIMEOUT Directive**:

**Changes made:**
1. **`sdqctl/core/conversation.py`** - Added `RUN_TIMEOUT` directive type and `run_timeout: int = 60` field; supports `30`, `30s`, or `2m` format
2. **`sdqctl/commands/run.py`** - Uses `conv.run_timeout` instead of hardcoded 60
3. **`tests/test_run_command.py`** - Added 5 tests for timeout parsing

**Usage example:**
```
RUN-TIMEOUT 2m
RUN npm run build
```

**Test status:** 362/362 passing

**Committed:** `ccd6fb9 feat(run): Add RUN-TIMEOUT directive for configurable command timeout`

---

## Cycle 2, Prompt 3

Done! Implemented **P2-1: Progress Tracker Format Documentation**:

**Changes made:**
1. **`README.md`** - Added `sdqctl apply` command section with:
   - Command examples
   - Progress file format with markdown table example
   - Status indicator explanations (‚úÖ ‚ùå üîÑ ‚è≥)

**Test status:** 362/362 passing

**Committed:** `7e25e9a docs: Add sdqctl apply and progress file format documentation`

---

## Cycle 3, Prompt 1

Done! Implemented **IQ-5: Verbose Flag Cleanup**:

**Changes made:**
1. **`sdqctl/commands/run.py`** - Removed `--verbose/-v` option and `verbose` parameter
2. **`sdqctl/commands/cycle.py`** - Same cleanup
3. **`sdqctl/commands/flow.py`** - Same cleanup
4. **`sdqctl/commands/apply.py`** - Same cleanup

**Improvement:** Verbosity is now consistently controlled by the global `-v` flag at CLI group level (e.g., `sdqctl -vv run workflow.conv`).

**Test status:** 362/362 passing

**Committed:** `a74003b refactor(cli): Remove duplicate --verbose flags from commands`

---

## Cycle 3, Prompt 2

Done! Implemented **P2: Token Estimation Inaccurate** (documentation approach):

**Changes made:**
1. **`sdqctl/core/context.py`** - Added module-level documentation explaining:
   - ~4 chars/token heuristic is approximate
   - Actual counts vary by model and content
   - Tiktoken recommended for precise GPT tokenization
2. Extracted `estimate_tokens(content)` helper function with docstring
3. Updated `ContextFile.tokens_estimate` comment to reference the function

**Test status:** 362/362 passing

**Committed:** `c542f69 docs(context): Document token estimation limitation`

---

## Cycle 3, Prompt 3

Done! Implemented **P2: Async Pattern Duplication**:

**Changes made:**
1. **`sdqctl/commands/utils.py`** - New file with `run_async(coro)` helper function
2. **`sdqctl/commands/run.py`** - Uses `run_async()` instead of `asyncio.run()`
3. **`sdqctl/commands/cycle.py`** - Same refactor
4. **`sdqctl/commands/flow.py`** - Same refactor (kept asyncio import for Semaphore/gather)
5. **`sdqctl/commands/apply.py`** - Same refactor (kept asyncio import for Semaphore/gather)

**Benefit:** Centralizes async execution, making future changes (error handling, event loop policy) easier.

**Test status:** 362/362 passing

**Committed:** `6e4ffd4 refactor(commands): Extract shared run_async helper`

---

## Meta

This report was generated by `progress-tracker.conv` - a quine-like workflow

that uses sdqctl to improve sdqctl.



To continue improvement:

```bash

sdqctl cycle examples/workflows/progress-tracker.conv \

--prologue reports/test-discovery-2026-01-21.md \

--adapter copilot

```