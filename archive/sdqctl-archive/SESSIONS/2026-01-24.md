# Session Logs: 2026-01-24

Archived from proposals/BACKLOG.md.

---

## Session 2026-01-24 (Documentation)

- [x] **VALIDATION-WORKFLOW.md** - Created comprehensive validation workflow guide
- [x] **Help topic: validation** - Added `sdqctl help validation`
- [x] **README.md** - Added cross-reference to validation workflow docs
- [x] **BACKLOG.md** - Added open questions section with prioritized items

---

## Session 2026-01-24 (Artifact Taxonomy)

- [x] **ARTIFACT-TAXONOMY.md** - Created comprehensive proposal with:
  - All artifact types enumerated (REQ, SPEC, TEST, GAP, UCA, SC, Q, BUG, PROP)
  - STPA safety artifacts (LOSS, HAZ)
  - Relationship hierarchy and validation rules
  - Enumeration strategies (sequential, category-scoped, project-scoped)
  - ID lifecycle and collision avoidance
  - Formatting guidelines

- [x] **Traceability verifier extended** (2026-01-24):
  - Added LOSS, HAZ, BUG, PROP, Q, IQ patterns
  - Extended TRACE_CHAIN for full STPA: LOSS → HAZ → UCA → SC → REQ
  - Added STANDALONE_TYPES (GAP, BUG, PROP, Q, IQ) allowed without links
  - Orphan detection for LOSS and HAZ (top of safety chain)
  - Coverage metrics: loss_to_haz, haz_to_uca
  - 11 new tests in test_verifiers.py

---

## Session 2026-01-24 (Documentation Philosophy)

- [x] **PHILOSOPHY.md** - Created comprehensive workflow design philosophy guide
  - Command roles: run (1 iteration) vs cycle (N iterations)
  - Anatomy of effective conversation files
  - Double diamond design pattern
  - Backlog-driven workflow design
  - Anti-patterns documentation
  - Reference examples table (6 good workflow patterns)
- [x] **GLOSSARY.md** - Enhanced terminology definitions
  - Added Prompt/Phase/Iteration/Cycle table
  - Added run vs cycle command disambiguation
  - Clarified that phases are NOT selectable steps
- [x] **Cross-references** - Added PHILOSOPHY.md links to:
  - GETTING-STARTED.md
  - SYNTHESIS-CYCLES.md
  - WORKFLOW-DESIGN.md
  - README.md
- [x] **Fixed broken link** - examples/workflows/README.md QUINE-WORKFLOWS.md → SYNTHESIS-CYCLES.md
- [x] **Audited 31 conv files** - Identified 7 good examples vs 24 needing improvements

### Conv File Audit Summary

**Good Examples** (correct terminology, scope partitioning, backlog-driven):
- `fix-quirks.conv` - Excellent terminology docs in comments
- `implement-improvements.conv` - Clear Triage→Implement→Document
- `proposal-development.conv` - State relay between cycles
- `sdk-debug-integration.conv` - Single item selection, blocker handling
- `test-discovery.conv` - Clear MODE audit, feeds implementation
- `deep-analysis.conv` - Good CHECKPOINT/COMPACT usage
- `REFCAT-DIRECTIVE.conv` - RUN-ON-ERROR for blocker surfacing

**Common Issues in Other Files**:
- Single-pass workflows (MAX-CYCLES 1) labeled as synthesis cycles
- Implicit cycle/phase definitions without explicit comments
- Missing blocker surfacing for documentation
- No persistent backlog tracking between iterations

**Terminology Fixes Applied (2026-01-24)**:
- Fixed `# === Cycle N:` → `# === Phase N:` in 6 conv files
- Added Terminology comments to implement-improvements, proposal-development, sdk-debug-integration

---

## Session 2026-01-24 (Unified Backlog Processor)

- [x] **backlog-processor.conv** - Created universal backlog iteration workflow
  - Works across ALL domains via `--prologue` injection
  - 6-phase pattern: select → execute → verify → docs → hygiene → triage
  - Aggressive COMPACT for long `-n 10+` runs
  - Git commit per meaningful change
  - No hardcoded file paths - fully reusable
- [x] **PHILOSOPHY.md** - Added Backlog Processor Pattern section
  - Documented universal workflow pattern
  - Added usage examples with multiple `--prologue` combinations
- [x] **BACKLOG.md** - Updated recommended commands
  - Universal backlog processor commands
  - Domain-specific alternatives

### Recommended Commands

**Universal Backlog Processor**:

```bash
# Process main proposal backlog (10 cycles)
sdqctl cycle examples/workflows/backlog-processor.conv \
  --prologue proposals/BACKLOG.md \
  --adapter copilot -n 10

# Process quirks backlog
sdqctl cycle examples/workflows/backlog-processor.conv \
  --prologue docs/QUIRKS.md \
  --adapter copilot -n 5

# Process multiple domains in one run
sdqctl cycle examples/workflows/backlog-processor.conv \
  --prologue proposals/BACKLOG.md \
  --prologue proposals/REFCAT-DESIGN.md \
  --prologue proposals/ARTIFACT-TAXONOMY.md \
  --adapter copilot -n 10
```

---

## Session 2026-01-24 (Verify CLI Commands)

- [x] **`sdqctl verify links`** - Added CLI command for links verifier
  - Scans markdown files for broken internal/external links
  - Options: `--json`, `--verbose`, `--path`
- [x] **`sdqctl verify traceability`** - Added CLI command with full features
  - `--coverage` flag shows detailed artifact coverage metrics
  - `--strict` flag treats warnings as errors
  - Coverage report format per ARTIFACT-TAXONOMY.md specification
  - Supports all artifact types: LOSS, HAZ, UCA, SC, REQ, SPEC, TEST, GAP, BUG, PROP, Q, IQ
- [x] **`sdqctl verify terminology`** - Added terminology consistency verifier
  - Detects deprecated terms (e.g., "quine" → "synthesis cycle")
  - Checks capitalization consistency (e.g., "nightscout" → "Nightscout", "stpa" → "STPA")
  - Auto-detects glossary from docs/GLOSSARY.md
  - Skips code blocks and CLI contexts
  - Options: `--glossary`, `--strict`, `--json`, `--verbose`
  - 12 tests in test_verifiers.py
- [x] **`sdqctl verify assertions`** - Added assertion tracing verifier
  - Scans Python, Swift, Kotlin, TypeScript for assertions
  - Detects trace IDs (REQ-NNN, SC-NNN, UCA-NNN) in messages/comments
  - `--require-message` and `--require-trace` flags for strict mode
  - Options: `--json`, `--verbose`, `--path`
  - 12 tests in test_verifiers.py
- [x] **`docs/NIGHTSCOUT-ECOSYSTEM.md`** - Created ecosystem conventions doc
  - workspace.lock.json configuration
  - Cross-project REFCAT reference syntax
  - Artifact ID ranges by project (loop, aaps, trio, xdrip, ns)
  - STPA artifact conventions for multi-project analysis
  - Verification commands and workflow patterns
- [x] **BACKLOG.md** - Updated verify command table with new CLI entries

---

## Session 2026-01-24 (Bug Investigation)

- [x] **BUG-001 investigation** - Compaction fails on empty context
  - Investigated reproduction steps with mock adapter
  - Cannot reproduce: empty context + COMPACT works correctly
  - Root cause: Issue likely specific to historical edge case or already fixed
  - Added regression test: `test_compact_with_empty_context` in `test_cycle_command.py`
  - Marked as RESOLVED in ARTIFACT-TAXONOMY.md

- [x] **ELIDE + RUN-RETRY validation** - Implement parse error for incompatible constructs
  - Added `validate_elide_chains()` method in `conversation.py`
  - Validates that RUN-RETRY cannot be used inside ELIDE chains
  - ELIDE merges steps into single turn; RUN-RETRY needs multiple turns
  - Integrated into `sdqctl validate` command
  - 4 tests in `test_conversation.py::TestElideChainValidation`
  - 1 CLI test in `test_cli.py::TestValidateCommand`

---

## Session 2026-01-24 (Q-012 Fix)

- [x] **Q-012: COMPACT directive now conditional** - Fix unconditional compaction
  - Added `session.needs_compaction(min_compaction_density)` check to COMPACT handling
  - Updated both `run.py` and `cycle.py` to check threshold before compacting
  - Shows "Skipping COMPACT - context below threshold" when skipped
  - Updated 2 tests, added `test_compact_executes_with_min_density_zero`
  - Marked Q-012 as FIXED in QUIRKS.md
  - **All quirks now resolved** - no active quirks remain
  - Commit: `d2e58df`

---

## Session 2026-01-24 (Error Handling Phase 1)

- [x] **Add `--strict` to all verify commands** - Production hardening
  - Added `--strict` flag to `verify refs`, `verify links`, `verify all`
  - `--strict` promotes warnings to errors for CI integration
  - Updated ERROR-HANDLING.md Phase 1 status to Complete
  - Added 4 tests in `test_cli.py::TestVerifyStrict`
  - Documentation: `sdqctl verify all --strict` for CI builds

---

## Session 2026-01-24 (SDK Metadata APIs Phase 1)

- [x] **Add metadata methods to adapters** - SDK v2 integration
  - Added `get_cli_status()`, `get_auth_status()`, `list_models()` to base adapter
  - Implemented in copilot adapter (calls SDK methods)
  - Implemented in mock adapter (returns test data)
  - Added 4 tests in `test_adapters.py::TestAdapterMetadataAPIs`
  - Updated SDK-METADATA-APIS.md Phase 1 to Complete

---

## Session 2026-01-24 (SDK Metadata APIs Phase 2)

- [x] **Enhanced status command** - SDK v2 metadata integration
  - Added `--models` flag to show available models with context/vision info
  - Added `--auth` flag to show authentication status details
  - Added `--all` flag for comprehensive status view
  - Added `-a/--adapter` option to specify which adapter to query
  - Implemented async metadata retrieval from adapters
  - Added 4 new tests in `tests/test_cli.py::TestStatusCommand`
  - Updated SDK-METADATA-APIS.md Phase 2 to Complete

---

## Session 2026-01-24 (Error Handling Phase 3)

- [x] **`--json-errors` global flag** - Structured error output for CI
  - Added `--json-errors` flag to main CLI group
  - Creates JSON output for all error types (MissingContextFiles, LoopDetected, etc.)
  - Suppresses progress messages when enabled (uses quiet mode)
  - Extended `core/exceptions.py` with:
    - `RunCommandFailed` exception for RUN directive failures
    - `exception_to_json()` function for exception serialization
    - `format_json_error()` function for JSON string output
    - New exit codes: `RUN_FAILED`, `VALIDATION_FAILED`, `VERIFY_FAILED`
  - Extended `utils/output.py` with:
    - `handle_error()` function for consistent error handling
    - `print_json_error()` function for ad-hoc JSON errors
  - Updated run and cycle commands to use structured error output
  - Added 3 tests in `tests/test_cli.py::TestJsonErrors`
  - Updated ERROR-HANDLING.md Phase 3 to Complete

---

## Session 2026-01-24 (REQUIRE Directive)

- [x] **`REQUIRE` directive** - Pre-flight checks for files and commands
  - Added `DirectiveType.REQUIRE` in `conversation.py`
  - Added `requirements` field to `ConversationFile` dataclass
  - Supports file requirements: `REQUIRE @pyproject.toml`
  - Supports command requirements: `REQUIRE cmd:git`
  - Supports multiple items: `REQUIRE @README.md cmd:python @tests/`
  - Supports glob patterns: `REQUIRE @*.py`
  - Added `validate_requirements()` method with file and command checking
  - Integrated into `sdqctl validate` command
  - Added 11 tests in `tests/test_conversation.py::TestRequireDirectiveParsing` and `TestRequireDirectiveValidation`
  - Added 2 CLI tests in `tests/test_cli.py::TestValidateCommand`
  - Updated directive count: 40 → 41 directives

---

## Session 2026-01-24 (ON-FAILURE/ON-SUCCESS Blocks)

- [x] **ON-FAILURE/ON-SUCCESS blocks** - Conditional execution after RUN (ERROR-HANDLING Phase 2)
  - Added `DirectiveType.ON_FAILURE`, `ON_SUCCESS`, `END` in `conversation.py`
  - Added `on_failure` and `on_success` list fields to `ConversationStep`
  - Implemented block parsing in `ConversationFile.parse()` with:
    - Block context tracking
    - Error checking for blocks without RUN, unclosed blocks, nested blocks
  - Added `_apply_directive_to_block()` helper for block-scoped directives
  - Updated `validate_elide_chains()` to detect blocks in ELIDE chains
  - Added `_execute_block_steps()` in `run.py` for executing block content
  - Updated RUN step handling to execute blocks based on exit code
  - Added 9 tests in `tests/test_conversation.py::TestOnFailureDirectiveParsing`
  - Updated directive count: 41 → 44 directives (ON-FAILURE, ON-SUCCESS, END)
  - Updated RUN-BRANCHING.md status to Implemented
  - Updated ERROR-HANDLING.md Phase 2 to Complete

---

## Session 2026-01-24 (Backlog Cohesiveness Audit)

- [x] **ARTIFACT-TAXONOMY.md** - Status updated: PROPOSAL → IMPLEMENTED (commit 0b3d463)
  - All artifact commands verified: `next`, `list`, `rename`, `retire`
- [x] **BACKLOG.md** - Fixed stale RUN-BRANCHING gap table (commit 35bbb2f)
  - ON-FAILURE/ON-SUCCESS marked as ✅ implemented
- [x] **ERROR-HANDLING.md** - Status updated: Draft → Implemented (commit 507a677)
  - ON-FAILURE/ON-SUCCESS moved to Implemented table

---

## Session 2026-01-24 (CHECK-* Aliases)

- [x] **Cohesiveness fix** - Fixed stale directive tables in BACKLOG.md (commit be4503f)
  - Updated directive count 41 → 44
  - Added Branching category (ON-FAILURE, ON-SUCCESS, END)
  - Removed ON-FAILURE/ON-SUCCESS from "NOT Implemented" table
- [x] **CHECK-* directive aliases** - Implemented verification shortcuts (commit 599166b)
  - Added `CHECK-REFS` (alias for `VERIFY refs`)
  - Added `CHECK-LINKS` (alias for `VERIFY links`)
  - Added `CHECK-TRACEABILITY` (alias for `VERIFY traceability`)
  - Updated directive count 44 → 47
  - Added 4 tests in `TestCheckAliasDirectives`
  - All 870 tests pass

---

## Session 2026-01-24 (INCLUDE Directive)

- [x] **`INCLUDE` directive** - Include other .conv files for workflow composition
  - Added `DirectiveType.INCLUDE` in `conversation.py`
  - Added `included_files` field to `ConversationFile` dataclass
  - Implemented `_process_include()` method with:
    - Recursive parsing of included files
    - Cycle detection to prevent infinite loops
    - Path resolution relative to including file
    - Merge of steps, context, prologues, epilogues, REFCAT refs
  - Metadata (MODEL, ADAPTER, etc.) is NOT merged from included files
  - Added 8 tests in `TestIncludeDirectiveParsing`
  - Updated directive count 47 → 48
  - All 878 tests pass

**Syntax:**
```dockerfile
# Include a common setup file
INCLUDE common/setup.conv

# Include from subdirectory
INCLUDE verification/stpa-checks.conv
```

**Use cases:**
- Reusable workflow fragments (common prologues, verification steps)
- Modular STPA workflow templates
- Shared context definitions across projects

---

## Session 2026-01-24 (VERIFY-TRACE Directive)

- [x] **`VERIFY-TRACE` directive** - Check specific trace links between artifacts
  - Added `DirectiveType.VERIFY_TRACE` in `conversation.py`
  - Added `verify_trace_links` field to `ConversationFile` dataclass
  - Parses `VERIFY-TRACE FROM_ID -> TO_ID` syntax (supports both `->` and `→`)
  - Added `verify_trace()` method to `TraceabilityVerifier`:
    - Checks if both artifacts exist in documentation
    - Detects direct links (same line with arrow)
    - Detects indirect links via BFS through trace chain
  - Added `sdqctl verify trace "FROM -> TO"` CLI command
  - Added 4 tests in `TestVerifyTraceDirective`
  - Added 5 tests in `TestTraceabilityVerifyTrace`
  - Updated directive count 48 → 49
  - All 887 tests pass

**Syntax:**
```dockerfile
# Check that UCA has safety constraint
VERIFY-TRACE UCA-001 -> SC-001

# Check scoped artifact links
VERIFY-TRACE UCA-BOLUS-003 → REQ-020
```

**CLI:**
```bash
# Verify specific trace link
sdqctl verify trace "UCA-001 -> SC-001"

# JSON output
sdqctl verify trace "SC-001 -> REQ-001" --json
```

---

## Session 2026-01-24 (Backlog Cohesiveness)

- [x] **BACKLOG.md directive count fix** - Updated 50 → 66 directives
  - Added `REFCAT` to Context category
  - Added `HELP` to Injection category
  - Removed `VERIFY-COVERAGE` from "NOT Implemented" (was duplicate)
  - Commit: `282cc12`

- [x] **Links verifier bug fix** - Skip links in code blocks and inline code
  - Added `CODE_BLOCK_PATTERN` to track fenced code blocks
  - Added `INLINE_CODE_PATTERN` to strip inline code before matching
  - Fixes 7 false positives in docs/ (VALIDATION-WORKFLOW, EXTENDING-VERIFIERS, TRACEABILITY-WORKFLOW)
  - Added 2 tests: `test_skip_links_in_code_blocks`, `test_skip_links_in_inline_code`
  - Commit: `7ee0461`
